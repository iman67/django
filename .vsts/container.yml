parameters:
  name: ''
  container: ''
  extra_requirements_file: ''

phases:

- phase: ${{ parameters.name }}
  queue:
    #name: Ubuntu 16.04
    name: Hosted Ubuntu 1604
    container: ${{ parameters.container }}

  steps:
    - script: |
        pip install --user unittest-xml-reporting
        pip install --user -r requirements/py3.txt
        if [ -n "$EXTRA_REQS" ]; then
          pip install --user -r requirements/$EXTRA_REQS
        fi
        pip install --user -e ..
      displayName: Install prereqs
      continueOnError: true
      workingDirectory: $(Build.SourcesDirectory)/tests
      env:
        EXTRA_REQS: ${{ parameters.extra_requirements_file }}
    
    - script: |
        su mysql
        /usr/local/bin/docker-entrypoint.sh mysqld
        sleep 10
        mysql --host=127.0.0.1 --port=3306 -u root --password=secret --execute="SELECT User, Host FROM mysql.user"
      displayName: Start MySQL
    
    - script: python runtests.py --noinput --settings ci_settings.test_mysql --verbosity 2
      displayName: Run tests
      continueOnError: true
      workingDirectory: $(Build.SourcesDirectory)/tests
      env:
        PYTHONPATH: $(Build.SourcesDirectory)/.vsts/
    
    # Skipped tests generate an invalid startDate. Until it's fixed,
    # delete test results which contain illegal timestamps.
    # https://github.com/xmlrunner/unittest-xml-reporting/issues/168
    - bash: |
        BAD_RESULTS=$(grep -El "0001-01-01" TEST-*.xml)
        if [ -n "$BAD_RESULTS" ]; then
          echo Removing: $BAD_RESULTS
          rm $BAD_RESULTS
        else
          echo No results to remove.
        fi
      displayName: Remove skipped test results
      continueOnError: true
      workingDirectory: $(Build.SourcesDirectory)/tests

    - task: PublishTestResults@2
      inputs:
        testResultsFiles: "**/TEST-*.xml"
        testRunTitle: ${{ parameters.name }}
      displayName: Publish test results
